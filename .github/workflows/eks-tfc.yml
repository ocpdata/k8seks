name: eks-tfc

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: "Optional EKS cluster name override"
        required: false
      region:
        description: "Optional AWS region override"
        required: false
      enable_nginx:
        description: "Deploy NGINX Plus (true/false)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      enable_cine:
        description: "Deploy cine app (true/false)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      terraform_target:
        description: "Target specific module (leave empty for all)"
        required: false
        type: choice
        options:
          - ""
          - "module.eks"
          - "module.nginx"
          - "module.cine"

permissions:
  contents: write

jobs:
  prep:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${AWS_REGION}" ]; then
            echo "AWS region is required (input region or secrets.AWS_REGION)."
            exit 1
          fi
        env:
          AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}

  plan:
    runs-on: ubuntu-latest
    needs: [prep]
    env:
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
      TF_TOKEN_app_terraform_io: ${{ secrets.TFC_TOKEN }}
      TF_WORKSPACE: k8seks
      AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}
      WORKSPACE_SUFFIX: k8seks
      CLUSTER_NAME_OVERRIDE: ${{ inputs.cluster_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform init
        run: |
          terraform init \
            -input=false \
            -backend-config="organization=${TFC_ORG}"

      - name: Terraform plan
        run: |
          if [ -n "${CLUSTER_NAME_OVERRIDE}" ]; then
            CLUSTER_NAME="${CLUSTER_NAME_OVERRIDE}"
          else
            CLUSTER_NAME="eks-${WORKSPACE_SUFFIX}"
          fi

          ENABLE_NGINX="${{ inputs.enable_nginx }}"
          ENABLE_CINE="${{ inputs.enable_cine }}"
          TERRAFORM_TARGET="${{ inputs.terraform_target }}"

          # Build terraform plan command
          PLAN_CMD="terraform plan"
          if [ -n "${TERRAFORM_TARGET}" ]; then
            PLAN_CMD="${PLAN_CMD} -target=${TERRAFORM_TARGET}"
          fi

          # Deploy EKS cluster with optional NGINX Plus and Cine
          ${PLAN_CMD} \
            -var="aws_region=${AWS_REGION}" \
            -var="cluster_name=${CLUSTER_NAME}" \
            -var="enable_nginx=${ENABLE_NGINX}" \
            -var="enable_cine=${ENABLE_CINE}" \
            -var="nginx_repo_crt=${NGINX_REPO_CRT:-}" \
            -var="nginx_repo_key=${NGINX_REPO_KEY:-}" \
            -var="license_jwt=${LICENSE_JWT:-}" \
            -var="data_plane_key=${DATA_PLANE_KEY:-}"
        env:
          NGINX_REPO_CRT: ${{ secrets.NGINX_REPO_CRT }}
          NGINX_REPO_KEY: ${{ secrets.NGINX_REPO_KEY }}
          LICENSE_JWT: ${{ secrets.LICENSE_JWT }}
          DATA_PLANE_KEY: ${{ secrets.DATA_PLANE_KEY }}

  apply-eks:
    runs-on: ubuntu-latest
    needs: [prep, plan]
    if: inputs.terraform_target != 'module.nginx' && inputs.terraform_target != 'module.cine'
    env:
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
      TF_TOKEN_app_terraform_io: ${{ secrets.TFC_TOKEN }}
      TF_WORKSPACE: k8seks
      AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}
      WORKSPACE_SUFFIX: k8seks
      CLUSTER_NAME_OVERRIDE: ${{ inputs.cluster_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform init
        run: |
          terraform init \
            -input=false \
            -backend-config="organization=${TFC_ORG}"

      - name: Terraform apply (EKS Cluster)
        run: |
          if [ -n "${CLUSTER_NAME_OVERRIDE}" ]; then
            CLUSTER_NAME="${CLUSTER_NAME_OVERRIDE}"
          else
            CLUSTER_NAME="eks-${WORKSPACE_SUFFIX}"
          fi

          terraform apply -auto-approve \
            -target=module.eks \
            -var="aws_region=${AWS_REGION}" \
            -var="cluster_name=${CLUSTER_NAME}" \
            -var="enable_nginx=false"

  apply-nginx:
    runs-on: ubuntu-latest
    needs: [prep, plan, apply-eks]
    if: ${{ always() && inputs.enable_nginx == 'true' && (inputs.terraform_target == 'module.nginx' || needs.apply-eks.result == 'success') && inputs.terraform_target != 'module.eks' && inputs.terraform_target != 'module.cine' }}
    env:
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
      TF_TOKEN_app_terraform_io: ${{ secrets.TFC_TOKEN }}
      TF_WORKSPACE: k8seks
      AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}
      WORKSPACE_SUFFIX: k8seks
      CLUSTER_NAME_OVERRIDE: ${{ inputs.cluster_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform init
        run: |
          terraform init \
            -input=false \
            -backend-config="organization=${TFC_ORG}"

      - name: Terraform apply (NGINX Plus)
        run: |
          if [ -n "${CLUSTER_NAME_OVERRIDE}" ]; then
            CLUSTER_NAME="${CLUSTER_NAME_OVERRIDE}"
          else
            CLUSTER_NAME="eks-${WORKSPACE_SUFFIX}"
          fi

          terraform apply -auto-approve \
            -target=module.nginx \
            -var="aws_region=${AWS_REGION}" \
            -var="cluster_name=${CLUSTER_NAME}" \
            -var="enable_nginx=true" \
            -var="nginx_repo_crt=${NGINX_REPO_CRT:-}" \
            -var="nginx_repo_key=${NGINX_RE PO_KEY:-}" \
            -var="license_jwt=${LICENSE_JWT:-}" \
            -var="data_plane_key=${DATA_PLANE_KEY:-}"
        env:
          NGINX_REPO_CRT: ${{ secrets.NGINX_REPO_CRT }}
          NGINX_REPO_KEY: ${{ secrets.NGINX_REPO_KEY }}
          LICENSE_JWT: ${{ secrets.LICENSE_JWT }}
          DATA_PLANE_KEY: ${{ secrets.DATA_PLANE_KEY }}

  apply-cine:
    runs-on: ubuntu-latest
    needs: [prep, plan, apply-eks]
    if: ${{ always() && inputs.enable_cine == 'true' && (inputs.terraform_target == 'module.cine' || needs.apply-eks.result == 'success') && inputs.terraform_target != 'module.eks' && inputs.terraform_target != 'module.nginx' }}
    env:
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
      TF_TOKEN_app_terraform_io: ${{ secrets.TFC_TOKEN }}
      TF_WORKSPACE: k8seks
      AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}
      WORKSPACE_SUFFIX: k8seks
      CLUSTER_NAME_OVERRIDE: ${{ inputs.cluster_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform init
        run: |
          terraform init \
            -input=false \
            -backend-config="organization=${TFC_ORG}"

      - name: Terraform apply (Cine App)
        run: |
          if [ -n "${CLUSTER_NAME_OVERRIDE}" ]; then
            CLUSTER_NAME="${CLUSTER_NAME_OVERRIDE}"
          else
            CLUSTER_NAME="eks-${WORKSPACE_SUFFIX}"
          fi

          terraform apply -auto-approve \
            -target=module.cine \
            -var="aws_region=${AWS_REGION}" \
            -var="cluster_name=${CLUSTER_NAME}" \
            -var="enable_cine=true"
