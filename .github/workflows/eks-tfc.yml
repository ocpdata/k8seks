name: eks-tfc

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: "Optional EKS cluster name override"
        required: false
      region:
        description: "Optional AWS region override"
        required: false
      enable_nginx:
        description: "Deploy NGINX Plus (true/false)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      enable_waf:
        description: "Enable F5 WAF for NGINX (true/false)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      build_waf_custom_image:
        description: "Build custom WAF image in workflow (true/false)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      nginx_waf_image_repository:
        description: "Optional custom WAF image repository"
        required: false
        default: "private-registry.nginx.com/nginx-ic-nap-v5/nginx-plus-ingress"
      nginx_waf_image_tag:
        description: "WAF image tag"
        required: false
        default: "5.2.1"
      enable_waf_monitor_policy:
        description: "Deploy WAF monitor policy for cine (true/false)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      enable_cine:
        description: "Deploy cine app (true/false)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      terraform_target:
        description: "Target specific module (leave empty for all)"
        required: false
        type: choice
        options:
          - ""
          - "module.eks"
          - "module.nginx"
          - "module.cine"

permissions:
  contents: write
  packages: write

jobs:
  prep:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${AWS_REGION}" ]; then
            echo "AWS region is required (input region or secrets.AWS_REGION)."
            exit 1
          fi
        env:
          AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}

  build-waf-image:
    runs-on: ubuntu-latest
    needs: [prep]
    if: ${{ inputs.enable_waf == 'true' && inputs.build_waf_custom_image == 'true' }}
    outputs:
      waf_image_repository: ${{ steps.meta.outputs.waf_image_repository }}
      waf_image_tag: ${{ steps.meta.outputs.waf_image_tag }}
    steps:
      - name: Set image metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          REPO="ghcr.io/${{ github.repository_owner }}/nginx-plus-ingress-waf"
          TAG="${{ inputs.nginx_waf_image_tag }}"
          echo "waf_image_repository=${REPO}" >> "$GITHUB_OUTPUT"
          echo "waf_image_tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Checkout NGINX Ingress source
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth 1 --branch v5.3.3 https://github.com/nginx/kubernetes-ingress.git

      - name: Prepare NGINX Plus cert/key
        shell: bash
        run: |
          set -euo pipefail
          cd kubernetes-ingress
          cat > nginx-repo.crt <<'CRT'
          ${{ secrets.NGINX_REPO_CRT }}
          CRT
          cat > nginx-repo.key <<'KEY'
          ${{ secrets.NGINX_REPO_KEY }}
          KEY

      - name: Login F5 registry
        shell: bash
        run: |
          set -euo pipefail
          docker login private-registry.nginx.com --username "${LICENSE_JWT}" --password "none"
        env:
          LICENSE_JWT: ${{ secrets.LICENSE_JWT }}

      - name: Login GHCR
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Build and push custom WAF image
        shell: bash
        run: |
          set -euo pipefail
          cd kubernetes-ingress
          REPO="${{ steps.meta.outputs.waf_image_repository }}"
          TAG="${{ steps.meta.outputs.waf_image_tag }}"
          make debian-image-nap-plus PREFIX="${REPO}" TARGET=download
          BUILT_TAG="$(docker images "${REPO}" --format '{{.Tag}}' | head -n1)"
          if [ -z "${BUILT_TAG}" ]; then
            echo "No se encontró imagen local construida para ${REPO}"
            exit 1
          fi
          if [ "${BUILT_TAG}" != "${TAG}" ]; then
            docker tag "${REPO}:${BUILT_TAG}" "${REPO}:${TAG}"
          fi
          docker push "${REPO}:${TAG}"

  plan:
    runs-on: ubuntu-latest
    needs: [prep]
    env:
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
      TF_TOKEN_app_terraform_io: ${{ secrets.TFC_TOKEN }}
      TF_WORKSPACE: k8seks
      AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}
      WORKSPACE_SUFFIX: k8seks
      CLUSTER_NAME_OVERRIDE: ${{ inputs.cluster_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Create Terraform Cloud workspace if not exists
        shell: bash
        run: |
          set -euo pipefail
          WORKSPACE_NAME="eks-k8seks"

          API="https://app.terraform.io/api/v2/organizations/${TFC_ORG}/workspaces/${WORKSPACE_NAME}"
          STATUS=$(curl -s -o /tmp/ws.json -w "%{http_code}" \
            -H "Authorization: Bearer ${TFC_TOKEN}" \
            -H "Content-Type: application/vnd.api+json" \
            "${API}")

          if [ "${STATUS}" = "200" ]; then
            echo "✓ Workspace ${WORKSPACE_NAME} already exists"
          elif [ "${STATUS}" = "404" ]; then
            echo "Creating workspace ${WORKSPACE_NAME}..."
            CREATE_STATUS=$(curl -s -o /tmp/ws_create.json -w "%{http_code}" \
              -X POST \
              -H "Authorization: Bearer ${TFC_TOKEN}" \
              -H "Content-Type: application/vnd.api+json" \
              -d "{\"data\":{\"type\":\"workspaces\",\"attributes\":{\"name\":\"${WORKSPACE_NAME}\",\"execution-mode\":\"local\",\"auto-apply\":false}}}" \
              "https://app.terraform.io/api/v2/organizations/${TFC_ORG}/workspaces")
            if [ "${CREATE_STATUS}" = "201" ] || [ "${CREATE_STATUS}" = "200" ]; then
              echo "✓ Workspace ${WORKSPACE_NAME} created successfully"
            else
              echo "✗ Failed to create workspace (status ${CREATE_STATUS})"
              cat /tmp/ws_create.json
              exit 1
            fi
          else
            echo "✗ Failed to query workspace (status ${STATUS})"
            cat /tmp/ws.json
            exit 1
          fi

      - name: Terraform init
        run: |
          terraform init \
            -input=false \
            -backend-config="organization=${TFC_ORG}"

      - name: Terraform plan
        run: |
          if [ -n "${CLUSTER_NAME_OVERRIDE}" ]; then
            CLUSTER_NAME="${CLUSTER_NAME_OVERRIDE}"
          else
            CLUSTER_NAME="eks-${WORKSPACE_SUFFIX}"
          fi

          ENABLE_NGINX="${{ inputs.enable_nginx }}"
          ENABLE_WAF="${{ inputs.enable_waf }}"
          WAF_IMAGE_REPOSITORY="${{ inputs.nginx_waf_image_repository }}"
          WAF_IMAGE_TAG="${{ inputs.nginx_waf_image_tag }}"
          ENABLE_CINE="${{ inputs.enable_cine }}"
          TERRAFORM_TARGET="${{ inputs.terraform_target }}"

          # Build terraform plan command
          PLAN_CMD="terraform plan"
          if [ -n "${TERRAFORM_TARGET}" ]; then
            PLAN_CMD="${PLAN_CMD} -target=${TERRAFORM_TARGET}"
          fi

          # Deploy EKS cluster with optional NGINX Plus and Cine
          ${PLAN_CMD} \
            -var="aws_region=${AWS_REGION}" \
            -var="cluster_name=${CLUSTER_NAME}" \
            -var="enable_nginx=${ENABLE_NGINX}" \
            -var="enable_nginx_waf=${ENABLE_WAF}" \
            -var="nginx_waf_image_repository=${WAF_IMAGE_REPOSITORY}" \
            -var="nginx_waf_image_tag=${WAF_IMAGE_TAG}" \
            -var="enable_cine=${ENABLE_CINE}" \
            -var="nginx_repo_crt=${NGINX_REPO_CRT:-}" \
            -var="nginx_repo_key=${NGINX_REPO_KEY:-}" \
            -var="license_jwt=${LICENSE_JWT:-}" \
            -var="data_plane_key=${DATA_PLANE_KEY:-}"
        env:
          NGINX_REPO_CRT: ${{ secrets.NGINX_REPO_CRT }}
          NGINX_REPO_KEY: ${{ secrets.NGINX_REPO_KEY }}
          LICENSE_JWT: ${{ secrets.LICENSE_JWT }}
          DATA_PLANE_KEY: ${{ secrets.DATA_PLANE_KEY }}

  apply-eks:
    runs-on: ubuntu-latest
    needs: [prep, plan]
    if: inputs.terraform_target != 'module.nginx' && inputs.terraform_target != 'module.cine'
    env:
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
      TF_TOKEN_app_terraform_io: ${{ secrets.TFC_TOKEN }}
      TF_WORKSPACE: k8seks
      AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}
      WORKSPACE_SUFFIX: k8seks
      CLUSTER_NAME_OVERRIDE: ${{ inputs.cluster_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform init
        run: |
          terraform init \
            -input=false \
            -backend-config="organization=${TFC_ORG}"

      - name: Terraform apply (EKS Cluster)
        run: |
          if [ -n "${CLUSTER_NAME_OVERRIDE}" ]; then
            CLUSTER_NAME="${CLUSTER_NAME_OVERRIDE}"
          else
            CLUSTER_NAME="eks-${WORKSPACE_SUFFIX}"
          fi

          terraform apply -auto-approve \
            -target=module.eks \
            -var="aws_region=${AWS_REGION}" \
            -var="cluster_name=${CLUSTER_NAME}" \
            -var="enable_nginx=false"

  apply-nginx:
    runs-on: ubuntu-latest
    needs: [prep, plan, apply-eks, build-waf-image]
    if: ${{ always() && inputs.enable_nginx == 'true' && (inputs.terraform_target == 'module.nginx' || needs.apply-eks.result == 'success') && inputs.terraform_target != 'module.eks' && inputs.terraform_target != 'module.cine' && (needs.build-waf-image.result == 'success' || needs.build-waf-image.result == 'skipped') }}
    env:
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
      TF_TOKEN_app_terraform_io: ${{ secrets.TFC_TOKEN }}
      TF_WORKSPACE: k8seks
      AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}
      WORKSPACE_SUFFIX: k8seks
      CLUSTER_NAME_OVERRIDE: ${{ inputs.cluster_name }}
      WAF_IMAGE_REPOSITORY: ${{ needs.build-waf-image.outputs.waf_image_repository != '' && needs.build-waf-image.outputs.waf_image_repository || inputs.nginx_waf_image_repository }}
      WAF_IMAGE_TAG: ${{ needs.build-waf-image.outputs.waf_image_tag != '' && needs.build-waf-image.outputs.waf_image_tag || inputs.nginx_waf_image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Configure kubeconfig
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${CLUSTER_NAME_OVERRIDE}" ]; then
            CLUSTER_NAME="${CLUSTER_NAME_OVERRIDE}"
          else
            CLUSTER_NAME="eks-${WORKSPACE_SUFFIX}"
          fi

          aws eks update-kubeconfig \
            --region "${AWS_REGION}" \
            --name "${CLUSTER_NAME}"

      - name: Apply NGINX CRDs
        shell: bash
        run: |
          set -euo pipefail
          helm show crds oci://ghcr.io/nginx/charts/nginx-ingress --version 2.4.3 | kubectl apply -f -

      - name: Terraform init
        run: |
          terraform init \
            -input=false \
            -backend-config="organization=${TFC_ORG}"

      - name: Terraform apply (NGINX Plus)
        run: |
          if [ -n "${CLUSTER_NAME_OVERRIDE}" ]; then
            CLUSTER_NAME="${CLUSTER_NAME_OVERRIDE}"
          else
            CLUSTER_NAME="eks-${WORKSPACE_SUFFIX}"
          fi

          terraform apply -auto-approve \
            -target=module.nginx \
            -var="aws_region=${AWS_REGION}" \
            -var="cluster_name=${CLUSTER_NAME}" \
            -var="enable_nginx=true" \
            -var="enable_nginx_waf=${{ inputs.enable_waf }}" \
            -var="nginx_waf_image_repository=${WAF_IMAGE_REPOSITORY}" \
            -var="nginx_waf_image_tag=${WAF_IMAGE_TAG}" \
            -var="nginx_repo_crt=${NGINX_REPO_CRT:-}" \
            -var="nginx_repo_key=${NGINX_REPO_KEY:-}" \
            -var="license_jwt=${LICENSE_JWT:-}" \
            -var="data_plane_key=${DATA_PLANE_KEY:-}"
        env:
          NGINX_REPO_CRT: ${{ secrets.NGINX_REPO_CRT }}
          NGINX_REPO_KEY: ${{ secrets.NGINX_REPO_KEY }}
          LICENSE_JWT: ${{ secrets.LICENSE_JWT }}
          DATA_PLANE_KEY: ${{ secrets.DATA_PLANE_KEY }}

  apply-cine:
    runs-on: ubuntu-latest
    needs: [prep, plan, apply-eks, apply-nginx]
    if: ${{ always() && inputs.enable_cine == 'true' && (inputs.terraform_target == 'module.cine' || (needs.apply-eks.result == 'success' && needs.apply-nginx.result == 'success')) && inputs.terraform_target != 'module.eks' && inputs.terraform_target != 'module.nginx' }}
    env:
      TFC_TOKEN: ${{ secrets.TFC_TOKEN }}
      TFC_ORG: ${{ secrets.TFC_ORG }}
      TF_TOKEN_app_terraform_io: ${{ secrets.TFC_TOKEN }}
      TF_WORKSPACE: k8seks
      AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}
      WORKSPACE_SUFFIX: k8seks
      CLUSTER_NAME_OVERRIDE: ${{ inputs.cluster_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform init
        run: |
          terraform init \
            -input=false \
            -backend-config="organization=${TFC_ORG}"

      - name: Terraform apply (Cine App)
        run: |
          if [ -n "${CLUSTER_NAME_OVERRIDE}" ]; then
            CLUSTER_NAME="${CLUSTER_NAME_OVERRIDE}"
          else
            CLUSTER_NAME="eks-${WORKSPACE_SUFFIX}"
          fi

          terraform apply -auto-approve \
            -target=module.cine \
            -var="aws_region=${AWS_REGION}" \
            -var="cluster_name=${CLUSTER_NAME}" \
            -var="enable_cine=true" \
            -var="omdb_api_key=${OMDB_API_KEY}"
        env:
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}

  apply-waf-monitor:
    runs-on: ubuntu-latest
    needs: [prep, apply-nginx, apply-cine]
    if: ${{ always() && inputs.enable_waf_monitor_policy == 'true' && inputs.enable_nginx == 'true' && inputs.enable_waf == 'true' && inputs.enable_cine == 'true' && needs.apply-nginx.result == 'success' && needs.apply-cine.result == 'success' }}
    env:
      AWS_REGION: ${{ inputs.region != '' && inputs.region || secrets.AWS_REGION }}
      WORKSPACE_SUFFIX: k8seks
      CLUSTER_NAME_OVERRIDE: ${{ inputs.cluster_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubeconfig
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${CLUSTER_NAME_OVERRIDE}" ]; then
            CLUSTER_NAME="${CLUSTER_NAME_OVERRIDE}"
          else
            CLUSTER_NAME="eks-${WORKSPACE_SUFFIX}"
          fi

          aws eks update-kubeconfig \
            --region "${AWS_REGION}" \
            --name "${CLUSTER_NAME}"

      - name: Docker login NGINX private registry
        shell: bash
        run: |
          set -euo pipefail
          docker login private-registry.nginx.com --username "${LICENSE_JWT}" --password "none"
        env:
          LICENSE_JWT: ${{ secrets.LICENSE_JWT }}

      - name: Deploy WAF monitor policy for cine
        shell: bash
        run: |
          set -euo pipefail
          bash ./waf/cine/deploy-monitor.sh
        env:
          LICENSE_JWT: ${{ secrets.LICENSE_JWT }}
